-- Konfigurasi
wait(2)
local petName = "Nightguard Afton"
local waitTimeTeleport = 2
local waitTimeBetweenTeleports = 2
local waitTimeBetweenLoops = 1
local loopCount = 5
local targetWaves = { "Wave 0/15", "Wave 1/15" }
local stopWave = "Wave 5/15"
local targetMoney = 3000 -- Ubah sesuai dengan jumlah money yang diinginkan

local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local Money = Player:WaitForChild("Money")
local PathWaveDetection = Player.PlayerGui.Top.Wave
local executedWaves = {}
local stopLoop = false
local moneyDetected = false -- Variabel untuk mendeteksi apakah targetMoney sudah tercapai

-- Fungsi untuk menghitung midpoint dengan logika dari Kumpulan Script Koordinat
local function calculateAdjustedMidpoint(parts, offset)
    local midpoint1 = (parts[1].Position + parts[2].Position) / 2
    local midpoint2 = (parts[3].Position + parts[4].Position) / 2
    return ((midpoint1 + midpoint2) / 2) + offset
end

-- Fungsi teleportasi dan summon pet
local function teleportAndSummon(parts, offset)
    if stopLoop then return end

    local character = Player.Character or Player.CharacterAdded:Wait()
    local adjustedPosition = calculateAdjustedMidpoint(parts, offset)
    character.HumanoidRootPart.CFrame = CFrame.new(adjustedPosition)

    task.wait(waitTimeTeleport)

    local argsReset = { [1] = "Reset" }
    game:GetService("ReplicatedStorage").Remotes.Misc.StopSettings:FireServer(unpack(argsReset))

    for i = 1, 68 do
        game:GetService("ReplicatedStorage").Remotes.Misc.StopSettings:FireServer()
    end

    local humanoidRootPartCFrame = character.HumanoidRootPart.CFrame
    local argsSummon = { [1] = petName, [2] = humanoidRootPartCFrame }
    game:GetService("ReplicatedStorage").Remotes.Towers.SummonTower:FireServer(unpack(argsSummon))
end

-- Fungsi utama untuk memulai summon
local function startSummoning()
    if stopLoop then return end
    stopLoop = true -- Hentikan loop setelah satu kali eksekusi

    for i = 1, loopCount do
        -- Cek apakah stopLoop diubah karena stopWave sudah tercapai
        if stopLoop then break end

        -- Posisi 1
        local parts1 = {
            workspace.Map:WaitForChild("Paths"):WaitForChild("1"):WaitForChild("Start"),
            workspace.Map:WaitForChild("Paths"):WaitForChild("1"):WaitForChild("4"),
            workspace.Map:WaitForChild("Paths"):WaitForChild("2"):WaitForChild("1"),
            workspace.Map:WaitForChild("Deco"):WaitForChild("Electrical Box"):WaitForChild("Meshes/Electrical Box_Cube.001")
        }
        teleportAndSummon(parts1, Vector3.new(17, 0, 15)) -- Offset untuk Posisi 1
        task.wait(waitTimeBetweenTeleports)

        -- Posisi 2
        local parts2 = {
            workspace.Map:WaitForChild("Paths"):WaitForChild("1"):WaitForChild("Start"),
            workspace.Map:WaitForChild("Paths"):WaitForChild("1"):WaitForChild("4"),
            workspace.Map:WaitForChild("Paths"):WaitForChild("2"):WaitForChild("1"),
            workspace.Map:WaitForChild("Deco"):WaitForChild("Electrical Box"):WaitForChild("Meshes/Electrical Box_Cube.001")
        }
        teleportAndSummon(parts2, Vector3.new(3, 0, 15)) -- Offset untuk Posisi 2
        task.wait(waitTimeBetweenTeleports)

        -- Posisi 3
        local parts3 = {
            workspace.Map:WaitForChild("Paths"):WaitForChild("1"):WaitForChild("Start"),
            workspace.Map:WaitForChild("Paths"):WaitForChild("1"):WaitForChild("4"),
            workspace.Map:WaitForChild("Paths"):WaitForChild("2"):WaitForChild("1"),
            workspace.Map:WaitForChild("Deco"):WaitForChild("Electrical Box"):WaitForChild("Meshes/Electrical Box_Cube.001")
        }
        teleportAndSummon(parts3, Vector3.new(9, 0, 15)) -- Offset untuk Posisi 3
        task.wait(waitTimeBetweenTeleports)

        task.wait(waitTimeBetweenLoops)
    end
end

-- Listener untuk mendeteksi perubahan teks di PathWaveDetection
PathWaveDetection:GetPropertyChangedSignal("Text"):Connect(function()
    if stopLoop then return end
    local waveText = PathWaveDetection.Text
    if waveText == stopWave then
        stopLoop = true
        print("Loop dihentikan karena mencapai " .. stopWave)
        return
    end

    if table.find(targetWaves, waveText) and not executedWaves[waveText] and not moneyDetected then
        executedWaves[waveText] = true
        startSummoning()
    end
end)

-- Listener untuk mendeteksi perubahan nilai Money
Money:GetPropertyChangedSignal("Value"):Connect(function()
    if Money.Value >= targetMoney and not moneyDetected then
        moneyDetected = true -- Tandai bahwa targetMoney sudah tercapai
        print("Jumlah money tercapai: " .. Money.Value)
        startSummoning()
    end
end)
